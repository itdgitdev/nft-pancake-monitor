{% extends "layout.html" %}

{% block content %}

    <h1 class="title">Mint Position(SOL)</h1>
    <div class="mint">
        <div class="container">
            <div class="mint-position">
                {% if mint_data %}
                    <h2>{{mint_data['token0_symbol']}} - {{ mint_data['token1_symbol'] }}</h2>
                    <div class="sub-title">
                        Current price: {{ "{:,.5f}".format(mint_data['current_price']) }}
                        {{mint_data['token1_symbol']}} per {{ mint_data['token0_symbol'] }}
                    </div>

                    <form id="mintForm">
                        <input type="hidden" name="chain" value="{{ chain }}">
                        <input type="hidden" name="pool_address" value="{{ pool_address }}">
                        <input type="hidden" name="token0_decimals" value="{{ mint_data['token0_decimals'] }}">
                        <input type="hidden" name="token1_decimals" value="{{ mint_data['token1_decimals'] }}">
                        <input type="hidden" name="current_price" id="current_price" value="{{ mint_data['current_price'] }}">

                        <div class="section">
                            <label for="token0">Token0 Amount({{ mint_data['token0_symbol'] }}): </label>
                            <input id="token0" name="amount0" type="number" 
                                placeholder="Token0 amount (e.g. 0.01)"
                                step="0.0001" 
                                required>

                            <label for="token1">Token1 Amount({{ mint_data['token1_symbol'] }}): </label>
                            <input id="token1" name="amount1" type="number"
                                placeholder="Token1 amount (auto calculated)"
                                step="0.0001"
                                readonly>
                        </div>

                        <div class="section">
                            <label>Price range:</label>
                            <div class="price-range">
                                <input type="number" id="minPrice" name="min_price" value="{{ min_price }}" placeholder="Min price" step="any">
                                <span>‚Üí</span>
                                <input type="number" id="maxPrice" name="max_price" value="{{ max_price }}" placeholder="Max price" step="any">
                            </div>
                        </div>

                        <button type="submit" class="submit-btn">Add Liquidity</button>
                    </form>

                {% endif %}
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
    <script>
        window.Buffer = buffer.Buffer; // g·∫Øn global
    </script>

    <script type="module">
        import { signAndSend } from '/static/js/mint_position_sol.js';
        
        function showToast(message, type = "success") {
            const t = document.getElementById("toast");
            if (!t) {
                console.error("‚ùå Toast element not found!");
                return;
            }

            t.innerHTML = message;         // <------ CHO PH√âP HTML
            t.classList.remove("success", "error");
            t.classList.add("show", type);

            setTimeout(() => {
                t.classList.remove("show");
            }, 3500);
        }

        const mintForm = document.getElementById("mintForm");
        if (!mintForm) {
            console.error("‚ùå mintForm not found!");
        } else {
            mintForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                
                const chain = document.querySelector("input[name=chain]").value;
                const pool_address = document.querySelector("input[name=pool_address]").value;
                const amount0 = parseFloat(document.querySelector("input[name=amount0]").value);
                const amount1 = parseFloat(document.querySelector("input[name=amount1]").value);
                const min_pct = parseFloat(document.querySelector("input[name=min_price]").value);
                const max_pct = parseFloat(document.querySelector("input[name=max_price]").value);
                const token0_decimals = document.querySelector("input[name=token0_decimals]").value;
                const token1_decimals = document.querySelector("input[name=token1_decimals]").value;
                
                let user;
                // 1Ô∏è‚É£ B·∫Øt tr∆∞·ªùng h·ª£p user reject connect wallet
                try {
                    console.log("üîå Connecting wallet...");
                    const resp = await window.solana.connect();
                    console.log("üîå connect() resp:", resp);
                    user = resp.publicKey.toString();
                    console.log("üë§ User:", user);
                } catch (err) {
                    console.error("‚ùå Wallet connect error:", err);

                    // Phantom / wallet chu·∫©n hay tr·∫£ code 4001 khi user reject
                    if (err?.code === 4001 || err?.message?.toLowerCase().includes("reject")) {
                        return showToast("‚ùå You rejected wallet connection", "error");
                    }

                    return showToast("‚ùå Wallet connection failed", "error");
                }

                try {
                    console.log("üîÑ Fetching mint params...");
                    
                    const url = `/get_mint_params?chain=${chain}&pool_address=${pool_address}`
                        + `&min_price=${min_pct}&max_price=${max_pct}`
                        + `&amount0=${amount0}&amount1=${amount1}`
                        + `&token0_decimals=${token0_decimals}&token1_decimals=${token1_decimals}`
                        + `&payer=${user}`;

                    console.log("üåê Request URL:", url);

                    const res = await fetch(url);
                    const results = await res.json();
                    
                    console.log("üì¶ Backend response:", results);

                    if (!results.msg_base64 || !results.position_nft_mint_secret) {
                        throw new Error("Backend response missing required fields");
                    }

                    console.log("‚úçÔ∏è Starting signing process...");
                    let txid;
                    try {
                        txid = await signAndSend(results.msg_base64, results.position_nft_mint_secret);
                    } catch (err) {
                        console.error("‚ùå signAndSend error:", err);

                        // 2Ô∏è‚É£ B·∫Øt user reject k√Ω transaction t·∫°i ƒë√¢y
                        if (err?.code === 4001 || err?.message?.toLowerCase().includes("reject")) {
                            return showToast("‚ùå You rejected the transaction", "error");
                        }

                        throw err; // n√©m l·∫°i ƒë·ªÉ xu·ªëng catch ngo√†i x·ª≠ l√Ω chung
                    }

                    // N·∫øu signAndSend kh√¥ng throw nh∆∞ng tr·∫£ v·ªÅ falsy khi user cancel
                    if (!txid) {
                        console.warn("‚ö†Ô∏è No txid returned (maybe user canceled signing?)");
                        return showToast("‚ùå Transaction was rejected", "error");
                    }

                    console.log("‚úÖ SUCCESS! TXID:", txid);
                    console.log("üîó https://solscan.io/tx/" + txid);

                    showToast(
                        `‚úÖ Mint successful! 
                        <br>
                        <span>View transaction on Solscan:  
                            <a href="https://solscan.io/tx/${txid}" target="_blank">
                                ${txid.slice(0, 8) + "..." + txid.slice(-8)}
                            </a>
                        </span>`,
                        "success"
                    );

                } catch (err) {
                    console.error("‚ùå Mint flow error:", err);
                    showToast("‚ùå Mint failed: " + (err?.message || "Unknown error"), "error");
                }
            });
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const amount0Input = document.getElementById("token0");
            const amount1Input = document.getElementById("token1");
            const minPriceInput = document.getElementById("minPrice");
            const maxPriceInput = document.getElementById("maxPrice");
            const currentPrice = document.getElementById("current_price");
            const submitBtn = document.querySelector(".submit-btn");

            function sqrt(x) {
                return Math.sqrt(parseFloat(x));
            }

            function calcAmount1() {
                let amount0 = parseFloat(amount0Input.value);
                let Pl = parseFloat(minPriceInput.value);
                let Pu = parseFloat(maxPriceInput.value);
                let Pc = parseFloat(currentPrice.value);

                if (!amount0 || !Pl || !Pu || !Pc) {
                    return;
                }

                const sqrtPl = sqrt(Pl);
                const sqrtPu = sqrt(Pu);
                const sqrtPc = sqrt(Pc);

                // CASE 1: Pc <= Pl ‚Üí position is 100% token0
                if (sqrtPc <= sqrtPl) {
                    amount1Input.value = 0;
                    return;
                }

                // CASE 2: Pc >= Pu ‚Üí cannot mint using token0 only
                if (sqrtPc >= sqrtPu) {
                    amount1Input.value = "0 (Price > max range)";
                    return;
                }

                // CASE 3: Pl < Pc < Pu ‚Üí mixed liquidity
                // Liquidity from amount0
                const L = amount0 / (1/sqrtPc - 1/sqrtPu);

                // amount1 needed
                const amount1 = L * (sqrtPc - sqrtPl);

                amount1Input.value = amount1.toFixed(6);
            }

            function validateForm() {
                let valid = true;

                // Ki·ªÉm tra Amount0
                if (!amount0Input.value || Number(amount1Input.value) <= 0) {
                    valid = false;
                }

                // Ki·ªÉm tra min/max price
                if (!minPriceInput.value || !maxPriceInput.value) {
                    valid = false;
                } else {
                    if (Number(minPriceInput.value) >= Number(maxPriceInput.value)) {
                        valid = false;
                    }
                }

                // Kh√≥a/m·ªü n√∫t
                submitBtn.disabled = !valid;

                // Style khi disable
                submitBtn.style.opacity = valid ? "1" : "0.5";
                submitBtn.style.cursor = valid ? "pointer" : "not-allowed";
            }

            amount0Input.addEventListener("input", calcAmount1);
            minPriceInput.addEventListener("input", calcAmount1);
            maxPriceInput.addEventListener("input", calcAmount1);

            // G·∫Øn event listener
            amount0Input.addEventListener("input", validateForm);
            minPriceInput.addEventListener("input", validateForm);
            maxPriceInput.addEventListener("input", validateForm);

            // Kh√≥a submit ngay t·ª´ ƒë·∫ßu
            validateForm();
        });
    </script>


{% endblock %}
